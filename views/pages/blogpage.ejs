<div class="min-h-screen text-slate-200 flex flex-col items-center py-1 px-4 space-y-10">

  <!-- Blog Header & Content -->
  <div class="w-full max-w-5xl rounded-2xl p-6 md:p-10 shadow-lg hover:shadow-slate-800/40 transition-all duration-300">
    
    <!-- Header -->
    <div class="flex items-center justify-between mb-6">
      <h1 class="text-3xl md:text-4xl font-bold text-cyan-400">
        <%= post.title %>
      </h1>
    </div>

    <!-- Image -->
    <% if (imageUrl) { %>
    <div class="flex justify-center mb-8">
      <img
        src="<%= imageUrl %>"
        alt="<%= post.title %>"
        class="rounded-lg shadow-md max-h-[300px] object-contain"
        loading="lazy"
      />
    </div>
    <% } %>

    <!-- Content -->
    <div class="prose prose-invert max-w-none text-slate-300 leading-relaxed space-y-6">
      <%- post.content %>
    </div>

  </div>

  <!-- Installation Guide Section -->
  <div class="w-full max-w-5xl bg-slate-900/60 backdrop-blur-md border border-slate-800 rounded-2xl p-6 md:p-10 shadow-lg hover:shadow-slate-800/40 transition-all duration-300">
    
    <h2 class="text-2xl font-semibold text-cyan-400 mb-4">
      Installation Guide
    </h2>

    <ol class="list-decimal list-inside text-slate-300 space-y-2">
      <li>Download and install a VMware virtualizer.</li>
      <li>Set both network adapters to <span class="text-cyan-400">NAT</span>.</li>
      <li>Adjust RAM and CPU for the VM according to your system specs (optional).</li>
      <li>Power on the virtual machine and wait for the login screen.</li>
      <li>Login with:
        <br><span class="text-cyan-400">Username:</span> root 
        <br><span class="text-cyan-400">Password:</span> hide01.ir
      </li>
      <li>Run <code class="bg-slate-800 px-2 py-1 rounded text-cyan-400">ifconfig | more</code> to find your internal IP.</li>
      <li>Open your browser and go to <code class="bg-slate-800 px-2 py-1 rounded text-cyan-400">https://IP:8834</code>.</li>
      <li>Wait 20‚Äì30 minutes for Nessus to prepare plugins and tools.</li>
      <li>Login to the Nessus UI with:
        <br><span class="text-cyan-400">Username:</span> nessus
        <br><span class="text-cyan-400">Password:</span> hide01.ir
      </li>
    </ol>
  </div>

  <!-- Download Box -->
  <% if (pdfUrl) { %>
  <div class="w-full max-w-5xl bg-gradient-to-r from-cyan-600/40 to-blue-600/40 border border-cyan-700/30 backdrop-blur-md rounded-2xl p-6 md:p-10 shadow-lg text-center space-y-4 hover:shadow-cyan-700/30 transition-all duration-300">
    
    <h2 class="text-2xl md:text-3xl font-semibold text-white">Download Resources</h2>
    <p class="text-slate-200 text-sm md:text-base max-w-2xl mx-auto">
      Access the PDF or documentation attached to this post.
    </p>

    <div class="flex flex-col md:flex-row items-center justify-center gap-4 mt-6">
      
      <% if (user) { %>
        <!-- User is logged in - Show generate button -->
        <button 
          id="generateLinkBtn"
          onclick="generateTemporaryLink('<%= post._id %>')" 
          class="px-6 py-3 bg-cyan-500 hover:bg-cyan-400 text-white rounded-md transition disabled:opacity-50 disabled:cursor-not-allowed">
          üîó Generate 1-Hour Download Link
        </button>
      <% } else { %>
        <!-- User is not logged in - Show login prompt -->
        <div class="text-center space-y-4">
          <p class="text-yellow-300 text-sm">
            üîí You must be logged in to download resources
          </p>
          <a 
            href="/login?redirect=<%= encodeURIComponent('/blog/' + post.slug) %>" 
            class="inline-block px-6 py-3 bg-cyan-500 hover:bg-cyan-400 text-white rounded-md transition">
            üîë Login to Download
          </a>
          <p class="text-slate-300 text-xs">
            Don't have an account? <a href="/register?redirect=<%= encodeURIComponent('/blog/' + post.slug) %>" class="text-cyan-300 hover:text-cyan-200 underline">Register here</a>
          </p>
        </div>
      <% } %>

    </div>

    <!-- Download Link Display -->
    <div id="downloadLinkBox" class="mt-6 hidden">
      <div class="bg-slate-900/60 border border-cyan-500/30 rounded-lg p-4 space-y-3">
        <p class="text-sm text-slate-200 font-semibold">‚úÖ Your unique download link (valid for 1 hour):</p>
        <div class="flex items-center gap-2 flex-wrap justify-center">
          <a 
            id="downloadLink" 
            href="#" 
            target="_blank" 
            class="text-cyan-300 hover:text-cyan-200 underline break-all text-sm">
          </a>
          <button 
            onclick="copyToClipboard()" 
            class="px-3 py-1 bg-slate-700 hover:bg-slate-600 text-white rounded text-xs transition">
            üìã Copy
          </button>
        </div>
        <p id="expiryTime" class="text-xs text-slate-400"></p>
      </div>
    </div>

    <!-- Loading Spinner -->
    <div id="loadingSpinner" class="mt-4 hidden">
      <div class="flex items-center justify-center gap-2">
        <div class="w-5 h-5 border-2 border-cyan-400 border-t-transparent rounded-full animate-spin"></div>
        <span class="text-slate-300 text-sm">Generating link...</span>
      </div>
    </div>

    <!-- Error Message -->
    <div id="errorMessage" class="mt-4 hidden">
      <div class="bg-red-900/30 border border-red-500/50 rounded-lg p-3">
        <p class="text-red-300 text-sm"></p>
      </div>
    </div>

    <p class="text-xs text-slate-400 mt-3">
      *Note: Link will automatically expire after 1 hour for security purposes.
    </p> 1 hour for security purposes.
    </p>
  </div>
  <% } %>

  <!-- Back to Blogs -->
  <div class="max-w-5xl w-full text-center">
    <a href="/blog" class="text-cyan-400 hover:text-cyan-300 transition font-medium">
      ‚Üê Back to all blogs
    </a>
  </div>

</div>

<script>
  let generatedLink = '';
  const isUserLoggedIn = <%= user ? 'true' : 'false' %>;

  async function generateTemporaryLink(postId) {
    // Double-check authentication (client-side)
    if (!isUserLoggedIn) {
      window.location.href = '/login?redirect=' + encodeURIComponent(window.location.pathname);
      return;
    }

    const btn = document.getElementById("generateLinkBtn");
    const linkBox = document.getElementById("downloadLinkBox");
    const linkElement = document.getElementById("downloadLink");
    const expiryElement = document.getElementById("expiryTime");
    const loadingSpinner = document.getElementById("loadingSpinner");
    const errorMessage = document.getElementById("errorMessage");

    // Reset UI
    linkBox.classList.add("hidden");
    errorMessage.classList.add("hidden");
    loadingSpinner.classList.remove("hidden");
    btn.disabled = true;

    try {
      console.log("üîÑ Requesting download link for post:", postId);
      
      const res = await fetch(`/api/generate-link/${postId}`);
      
      console.log("üì° Response status:", res.status);
      console.log("üì° Response ok:", res.ok);
      
      // Check for authentication error
      if (res.status === 401) {
        showError("Please log in to download resources");
        setTimeout(() => {
          window.location.href = '/login?redirect=' + encodeURIComponent(window.location.pathname);
        }, 2000);
        return;
      }
      
      const contentType = res.headers.get("content-type");
      console.log("üìÑ Content-Type:", contentType);

      let data;
      if (contentType && contentType.includes("application/json")) {
        data = await res.json();
        console.log("üì¶ Response data:", data);
      } else {
        const text = await res.text();
        console.error("‚ùå Received non-JSON response:", text);
        throw new Error("Server returned invalid response format");
      }

      loadingSpinner.classList.add("hidden");
      btn.disabled = false;

      if (data.success && data.downloadURL) {
        generatedLink = data.downloadURL;
        
        // Display the link
        linkElement.href = data.downloadURL;
        linkElement.textContent = data.downloadURL;
        linkBox.classList.remove("hidden");

        // Display expiry time
        if (data.expiresAt) {
          const expiryDate = new Date(data.expiresAt);
          expiryElement.textContent = `Expires at: ${expiryDate.toLocaleString()}`;
        }

        // Show success notification
        showNotification("‚úÖ Temporary link generated successfully!", "success");
      } else {
        const errorMsg = data.message || "Failed to generate link";
        console.error("‚ùå Server error:", errorMsg);
        showError(errorMsg);
      }
    } catch (err) {
      console.error("‚ùå Fetch error:", err);
      console.error("Error details:", {
        message: err.message,
        stack: err.stack
      });
      
      loadingSpinner.classList.add("hidden");
      btn.disabled = false;
      
      let errorMsg = "Server error while generating link. ";
      if (err.message.includes("Failed to fetch")) {
        errorMsg += "Please check if the server is running.";
      } else if (err.message.includes("JSON")) {
        errorMsg += "Server returned invalid response.";
      } else {
        errorMsg += err.message;
      }
      
      showError(errorMsg);
    }
  }

  function copyToClipboard() {
    if (!generatedLink) return;

    navigator.clipboard.writeText(generatedLink)
      .then(() => {
        showNotification("üìã Link copied to clipboard!", "success");
      })
      .catch(err => {
        console.error("Copy failed:", err);
        showNotification("‚ùå Failed to copy link", "error");
      });
  }

  function showError(message) {
    const errorBox = document.getElementById("errorMessage");
    errorBox.querySelector("p").textContent = message;
    errorBox.classList.remove("hidden");
    
    // Auto-hide after 8 seconds
    setTimeout(() => {
      errorBox.classList.add("hidden");
    }, 8000);
  }

  function showNotification(message, type = "success") {
    // Create notification element
    const notification = document.createElement("div");
    notification.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg transition-all duration-300 transform translate-x-0 z-50 ${
      type === "success" ? "bg-green-600 text-white" : "bg-red-600 text-white"
    }`;
    notification.textContent = message;

    document.body.appendChild(notification);

    // Remove after 3 seconds
    setTimeout(() => {
      notification.style.transform = "translateX(400px)";
      setTimeout(() => notification.remove(), 300);
    }, 3000);
  }
</script>