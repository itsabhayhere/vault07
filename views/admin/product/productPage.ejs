<div class="container mx-auto py-8">
  <h1 class="text-3xl font-bold mb-6">Product Management</h1>

  <!-- Add Product Button -->
  <div class="mb-6">
    <button
      onclick="openCreateProductModal()"
      class="bg-blue-500 hover:bg-blue-600 text-white font-semibold px-5 py-2 rounded shadow"
    >
      + Add Product
    </button>
  </div>

  <!-- Products Table -->
  <div class="overflow-x-auto shadow rounded-lg">
    <table class="min-w-full bg-white border border-gray-200">
      <thead class="bg-gray-100 text-gray-700 uppercase text-sm">
        <tr>
          <th class="py-3 px-4 border">#</th>
          <th class="py-3 px-4 border">Image</th>
          <th class="py-3 px-4 border">Name</th>
          <th class="py-3 px-4 border">Category</th>
          <th class="py-3 px-4 border">eCode</th>
          <th class="py-3 px-4 border">Description</th>
          <th class="py-3 px-4 border">Actions</th>
        </tr>
      </thead>
      <tbody class="text-gray-800 text-sm">
        <% if(products.length === 0){ %>
          <tr>
            <td colspan="7" class="text-center py-4">No products found</td>
          </tr>
        <% } else { %>
          <% products.forEach((product, index) => { %>
          <tr class="<%= index % 2 === 0 ? 'bg-white' : 'bg-gray-50' %> hover:bg-gray-100">
            <td class="py-2 px-4 border text-center"><%= index + 1 %></td>
            <td class="py-2 px-4 border">
              <% if(product.image){ %>
              <img src="/<%= product.image %>" alt="<%= product.name %>" class="w-16 h-16 object-cover rounded mx-auto" />
              <% } else { %> N/A <% } %>
            </td>
            <td class="py-2 px-4 border"><%= product.name %></td>
            <td class="py-2 px-4 border"><%= product.category ? product.category.name : 'N/A' %></td>
            <td class="py-2 px-4 border"><%= product.eCode %></td>
            <td class="py-2 px-4 border"><%= product.description || 'N/A' %></td>
            <td class="py-2 px-4 border flex gap-2 justify-center">
              <button
                onclick="openEditProductModal('<%= product._id %>', '<%= product.name %>', '<%= product.eCode %>', '<%= product.description || '' %>', '<%= product.category ? product.category._id : '' %>')"
                class="text-blue-600 hover:underline font-medium"
              >
                Edit
              </button>
              <form action="/admin/products/delete/<%= product._id %>?_method=DELETE" method="POST">
                <button type="submit" class="text-red-600 hover:underline font-medium"
                        onclick="return confirm('Are you sure you want to delete this product?')">
                  Delete
                </button>
              </form>
            </td>
          </tr>
          <% }) %>
        <% } %>
      </tbody>
    </table>
  </div>
</div>

<!-- Create Product Modal -->
<div id="createProductModal" class="fixed inset-0 bg-black bg-opacity-50 hidden justify-center items-center z-50">
  <div class="bg-white rounded-lg shadow-lg w-96 p-6 relative">
    <h2 class="text-xl font-semibold mb-5">Create Product</h2>

    <form id="createProductForm" action="/admin/products/create" method="POST" enctype="multipart/form-data">
      <div class="mb-4">
        <label class="block font-medium mb-1">Product Name</label>
        <input type="text" name="name" class="w-full border px-3 py-2 rounded focus:outline-none focus:ring-2 focus:ring-blue-500" required />
      </div>

      <div class="mb-4">
        <label class="block font-medium mb-1">Category</label>
        <select name="category" class="w-full border px-3 py-2 rounded focus:outline-none focus:ring-2 focus:ring-blue-500" required>
          <option value="">Select Category</option>
          <% categories.forEach(cat => { %>
            <option value="<%= cat._id %>"><%= cat.name %></option>
          <% }) %>
        </select>
      </div>

      <div class="mb-4">
        <label class="block font-medium mb-1">Product eCode</label>
        <input type="text" name="eCode" class="w-full border px-3 py-2 rounded focus:outline-none focus:ring-2 focus:ring-blue-500" required />
      </div>

      <div class="mb-4">
        <label class="block font-medium mb-1">Description</label>
        <textarea name="description" rows="3" class="w-full border px-3 py-2 rounded focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
      </div>

      <div class="mb-4">
        <label class="block font-medium mb-1">Product Image</label>
        <input type="file" name="image" accept="image/*" class="w-full border px-3 py-2 rounded focus:outline-none focus:ring-2 focus:ring-blue-500" required />
      </div>

      <div class="flex justify-end gap-2">
        <button type="button" onclick="closeCreateProductModal()" class="px-4 py-2 rounded bg-gray-300 hover:bg-gray-400">Cancel</button>
        <button type="submit" class="px-4 py-2 rounded bg-blue-500 text-white hover:bg-blue-600">Create</button>
      </div>
    </form>
  </div>
</div>

<!-- Edit Product Modal -->
<div id="editProductModal" class="fixed inset-0 bg-black bg-opacity-50 hidden justify-center items-center z-50">
  <div class="bg-white rounded-lg shadow-lg w-96 p-6 relative">
    <h2 class="text-xl font-semibold mb-5">Edit Product</h2>

    <form id="editProductForm" method="POST" enctype="multipart/form-data">
      <input type="hidden" name="_method" value="PUT" />

      <div class="mb-4">
        <label class="block font-medium mb-1">Product Name</label>
        <input type="text" name="name" id="editProductName" class="w-full border px-3 py-2 rounded focus:outline-none focus:ring-2 focus:ring-blue-500" required />
      </div>

      <div class="mb-4">
        <label class="block font-medium mb-1">Category</label>
        <select name="category" id="editProductCategory" class="w-full border px-3 py-2 rounded focus:outline-none focus:ring-2 focus:ring-blue-500" required>
          <option value="">Select Category</option>
          <% categories.forEach(cat => { %>
            <option value="<%= cat._id %>"><%= cat.name %></option>
          <% }) %>
        </select>
      </div>

      <div class="mb-4">
        <label class="block font-medium mb-1">Product eCode</label>
        <input type="text" name="eCode" id="editProductECode" class="w-full border px-3 py-2 rounded focus:outline-none focus:ring-2 focus:ring-blue-500" required />
      </div>

      <div class="mb-4">
        <label class="block font-medium mb-1">Description</label>
        <textarea name="description" id="editProductDescription" rows="3" class="w-full border px-3 py-2 rounded focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
      </div>

      <div class="mb-4">
        <label class="block font-medium mb-1">Product Image</label>
        <input type="file" name="image" accept="image/*" class="w-full border px-3 py-2 rounded focus:outline-none focus:ring-2 focus:ring-blue-500" />
      </div>

      <div class="flex justify-end gap-2">
        <button type="button" onclick="closeEditProductModal()" class="px-4 py-2 rounded bg-gray-300 hover:bg-gray-400">Cancel</button>
        <button type="submit" class="px-4 py-2 rounded bg-blue-500 text-white hover:bg-blue-600">Save</button>
      </div>
    </form>
  </div>
</div>

<!-- Modal Scripts -->
<script>
  // --- Create Product Modal ---
  function openCreateProductModal() {
    const modal = document.getElementById("createProductModal");
    modal.classList.remove("hidden");
    modal.classList.add("flex");
  }
  function closeCreateProductModal() {
    const modal = document.getElementById("createProductModal");
    modal.classList.remove("flex");
    modal.classList.add("hidden");
  }
  document.getElementById("createProductModal").addEventListener("click", function(e) {
    if(e.target === this) closeCreateProductModal();
  });

  // --- Edit Product Modal ---
  function openEditProductModal(id, name, eCode, description, categoryId) {
    const modal = document.getElementById("editProductModal");
    const form = document.getElementById("editProductForm");
    document.getElementById("editProductName").value = name;
    document.getElementById("editProductECode").value = eCode;
    document.getElementById("editProductDescription").value = description || '';
    document.getElementById("editProductCategory").value = categoryId || '';
    form.action = `/admin/products/update/${id}?_method=PUT`;
    modal.classList.remove("hidden");
    modal.classList.add("flex");
  }
  function closeEditProductModal() {
    const modal = document.getElementById("editProductModal");
    modal.classList.remove("flex");
    modal.classList.add("hidden");
  }
  document.getElementById("editProductModal").addEventListener("click", function(e) {
    if(e.target === this) closeEditProductModal();
  });
</script>
